<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Dr.&nbsp;Matthijs Hollanders">
<meta name="dcterms.date" content="2024-10-09">

<title>Quantecol - Default to Gaussian processes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../img/Icon-Quantecol-RGB-FA-1-500.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="Quantecol - Default to Gaussian processes">
<meta property="og:description" content="">
<meta property="og:image" content="https://quantecol.com.au/img/fleayi-huge.jpg">
<meta property="og:site-name" content="Quantecol">
<meta name="twitter:title" content="Quantecol - Default to Gaussian processes">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://quantecol.com.au/img/fleayi-huge.jpg">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../img/Logo-Quantecol-RGB-FA-2-1000.png" alt="" class="navbar-logo">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../services.html" rel="" target="">
 <span class="menu-text">Services</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../portfolio.html" rel="" target="">
 <span class="menu-text">Portfolio</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../blog.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-about" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">About</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-about">    
        <li>
    <a class="dropdown-item" href="../about/vision.html" rel="" target="">
 <span class="dropdown-text">Our Vision</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../about/people/matthijs.html" rel="" target="">
 <span class="dropdown-text">People</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../about/contact.html" rel="" target="">
 <span class="dropdown-text">Contact Us</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/realQuantecol" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#example-tadpole-counts" id="toc-example-tadpole-counts" class="nav-link" data-scroll-target="#example-tadpole-counts">Example: tadpole counts</a></li>
  <li><a href="#setting-priors-for-gps" id="toc-setting-priors-for-gps" class="nav-link" data-scroll-target="#setting-priors-for-gps">Setting priors for GPs</a></li>
  <li><a href="#fitting-the-model" id="toc-fitting-the-model" class="nav-link" data-scroll-target="#fitting-the-model">Fitting the model</a></li>
  <li><a href="#plotting-predictions" id="toc-plotting-predictions" class="nav-link" data-scroll-target="#plotting-predictions">Plotting predictions</a>
  <ul class="collapse">
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Why you should default to Gaussian processes for random spatial and temporal effects</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p><a href="../about/people/matthijs.html">Dr.&nbsp;Matthijs Hollanders</a> </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 9, 2024</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>It is common to use random effects to capture heterogeneity in data that have been collected at spatial and/or temporal intervals. For example, counts of species or individuals are frequently replicated in space and time and researchers may add site or survey date as random effects in the model. These random effects are typically modeled as being normally distributed. Consider surveys <span class="math inline">\(i \in 1:I\)</span> where counts <span class="math inline">\(y_i\)</span> are made which we model with Poisson regression. The model with normally distributed random survey effects on the log expected count looks like this:</p>
<p><span id="eq-normal"><span class="math display">\[
\begin{aligned}
  y_i &amp;\sim \textrm{Poisson} \left( \exp(\alpha + \epsilon_i) \right) \\
  \epsilon_i &amp;\sim \textrm{Normal} \left( 0, \tau \right)
\end{aligned}
\tag{1}\]</span></span></p>
<p>where the intercept <span class="math inline">\(\alpha\)</span>, the random survey-level offsets <span class="math inline">\(\epsilon_i\)</span>, and the standard deviation of the survey effects <span class="math inline">\(\tau\)</span> are to be estimated by the model. In this post, I argue that when the random effects are not expected to be independent it almost always makes more sense to model the random effects using Gaussian processes (GPs).</p>
<p>GPs are a bit complicated <span class="citation" data-cites="simpson2021">(<a href="#ref-simpson2021" role="doc-biblioref">Simpson 2021</a>)</span> but one of their salient features is that any set of observations generated by a Gaussian process are marginally distributed as multivariate normal <span class="math inline">\(\textrm{Normal} (\boldsymbol{\mu}, \Sigma)\)</span>.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> In practice, the realisations of the GP are added to our linear predictor so <span class="math inline">\(\boldsymbol{\mu} = \boldsymbol{0}\)</span>. There are quite a few covariance kernels <span class="math inline">\(\Sigma\)</span> to choose from but one of the most common is the exponentiated quadratic kernel given by <span id="eq-K"><span class="math display">\[
\Sigma_{ij} = \tau^2 \exp \left( -\frac{\lVert \boldsymbol{x}_i - \boldsymbol{x}_j \rVert^2}{2 \rho ^2} \right),
\tag{2}\]</span></span></p>
<p>where <span class="math inline">\(\tau^2\)</span> is the marginal variance (analogous to variance <span class="math inline">\(\tau^2\)</span> with normally distributed random effects), <span class="math inline">\(\rho\)</span> is the length-scale governing the covariance between observations, and the term <span class="math inline">\(\lVert \boldsymbol{x}_i - \boldsymbol{x}_j \rVert\)</span> is the Euclidean distance between any two points of our input.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> The length-scale <span class="math inline">\(\rho\)</span> governs the correlation between points as a function of the distance between them. When <span class="math inline">\(\rho\)</span> is small, there is little correlation between neighbouring locations and when <span class="math inline">\(\rho\)</span> is large, there is high correlation between observations. Essentially, GPs allow modeling normally distributed random effects where observations close to each other (as in, surveys conducted at the same time of year) may be correlated.</p>
</section>
<section id="example-tadpole-counts" class="level2">
<h2 class="anchored" data-anchor-id="example-tadpole-counts">Example: tadpole counts</h2>
<p>For this example, I’ll use data we collected on tadpoles of Fleay’s barred frogs (<em>Mixophyes fleayi</em>), a stream-dwelling species endemic to the Gondwana rainforests of northern New South Wales and southeast Queensland, Australia <span class="citation" data-cites="hollanders2024">(<a href="#ref-hollanders2024" role="doc-biblioref">Hollanders et al. 2024</a>)</span>. During my PhD, I swept a dipnet through pools in the creeks for roughly 1 min every six weeks, deposited the tadpoles in a tub, took a photograph from above, and used Photoshop to count and measure the tadpoles.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> Here, I’ll fit the model in <a href="#eq-normal">Equation&nbsp;1</a> with and without GP to model the number of tadpoles I captured during each six-weekly survey at one of the sites. First I’ll download the data from my GitHub and plot the counts for the creek using <strong>ggplot2</strong> <span class="citation" data-cites="wickham2016">(<a href="#ref-wickham2016" role="doc-biblioref">Wickham 2016</a>)</span> and other packages from the <strong>tidyverse</strong> <span class="citation" data-cites="wickham2019">(<a href="#ref-wickham2019" role="doc-biblioref">Wickham et al. 2019</a>)</span>.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># download data</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3"></a>dat <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://raw.githubusercontent.com/mhollanders/mfleayi-tadpoles/main/data/tadpole-lengths.csv"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb1-4"><a href="#cb1-4"></a>  <span class="fu">filter</span>(site <span class="sc">==</span> <span class="st">"brindle"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb1-5"><a href="#cb1-5"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">dmy</span>(date)) <span class="sc">|&gt;</span> </span>
<span id="cb1-6"><a href="#cb1-6"></a>  <span class="fu">count</span>(date)</span>
<span id="cb1-7"><a href="#cb1-7"></a></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="co"># plot the counts</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>fig <span class="ot">&lt;-</span> dat <span class="sc">|&gt;</span> </span>
<span id="cb1-10"><a href="#cb1-10"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(date, n)) <span class="sc">+</span> </span>
<span id="cb1-11"><a href="#cb1-11"></a>  <span class="fu">geom_point</span>(<span class="at">colour =</span> green, <span class="at">shape =</span> <span class="dv">16</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="dv">3</span><span class="sc">/</span><span class="dv">4</span>) <span class="sc">+</span> </span>
<span id="cb1-12"><a href="#cb1-12"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">50</span>, <span class="dv">200</span>, <span class="dv">50</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">225</span>), <span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span> </span>
<span id="cb1-13"><a href="#cb1-13"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Survey"</span>, <span class="at">y =</span> <span class="st">"Number of tadpoles"</span>)</span>
<span id="cb1-14"><a href="#cb1-14"></a>fig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="gaussian-processes_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Fleay’s barred frogs breed from the early spring to the middle of summer and generally there are several pulses of reproduction resulting in fresh cohorts of tadpoles. We’ll ignore this and just model the counts using random survey effects in the absence of any predictors.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../img/fleayi-huge.jpg" class="img-fluid figure-img" style="width:88.6%"></p>
<figcaption class="figure-caption">Fleay’s barred frog (<em>Mixophyes fleayi</em>) from Brindle Creek, Border Ranges National Park, Australia.</figcaption>
</figure>
</div>
</section>
<section id="setting-priors-for-gps" class="level2">
<h2 class="anchored" data-anchor-id="setting-priors-for-gps">Setting priors for GPs</h2>
<p>GPs have two parameters that require priors, <span class="math inline">\(\tau\)</span> and <span class="math inline">\(\rho\)</span>. The prior for <span class="math inline">\(\tau\)</span> can just be something like an exponential prior commonly used for standard deviations of random effects.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> The prior for the length-scale <span class="math inline">\(\rho\)</span> is trickier as it is often not well identified by the data. In fact, the data cannot inform length-scales that are outside of the distances observed in the data. This means that we want a prior than can suppress values below and above certain thresholds. One popular distribution for length-scales that’s capable of doing exactly this is the inverse gamma distribution. Michael Betancourt’s GP <a href="https://betanalpha.github.io/assets/case_studies/gaussian_processes.html#323_Informative_Prior_Model">case study</a> discusses this at length and includes a function that uses Stan’s algebra solver to determine the shape and scale of the inverse gamma distribution that places a certain proportion of the probability mass between two values.<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a></p>
<p>If the study was well designed to estimate the length-scale of the GP, the survey intervals should be shorter than the minimum length-scale we think we might be dealing with. Unfortunately, I did not collect data with this question in mind, and I can easily see that the relevant length-scale is shorter than the minimum length between surveys (I surveyed at six-weekly intervals, give or take). However, for this demonstration, we’ll assume that the survey intervals were rigorously chosen and we’ll use the minimum and maximum observed temporal distances between surveys to choose a suitable inverse gamma prior for the length-scale. So, I compute the minimum and maximum distance and chose tail probabilities of 1% so that 98% of the probability mass of the length-scale falls between the minimum and maximum observed distances between the surveys.</p>
</section>
<section id="fitting-the-model" class="level2">
<h2 class="anchored" data-anchor-id="fitting-the-model">Fitting the model</h2>
<p>Below I write out a Stan program <span class="citation" data-cites="carpenter2017">(<a href="#ref-carpenter2017" role="doc-biblioref">Carpenter et al. 2017</a>)</span> that uses an indicator to use either normally distributed random effects or to use a GP with a exponentiated quadratic covariance kernel. Stan includes the handy function <code>gp_exp_quad_cov()</code> that generates this covariance kernel from the input (survey times expressed in weeks, in this case) and standard deviation and length-scale. We also use this GP input to pre-compute the distance matrix to get the minimum and maximum observed (temporal) distances of the surveys to use Stan’s algebra solver to determine a suitable inverse gamma prior for <span class="math inline">\(\rho\)</span>. For both types of random effects I use the non-centered parameterisation which generally has better sampling for few observations (we only have 10 data points). For GPs (and multivariate normals more generally), this entails Cholesky decomposing the covariance matrix (think of it as a matrix square root) and multiplying it by a vector of standard normal variates. Note that before Cholesky decomposing the covariance kernel, I add a diagonal matrix with a very small value (called the “nugget” or “jitter”) to ensure the matrix is positive definite.</p>
<div class="cell" data-output.var="mod">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource stan number-lines code-with-copy"><code class="sourceCode stan"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">functions</span> {</span>
<span id="cb2-2"><a href="#cb2-2"></a>  <span class="co">// function from Michael Betancourt for inverse gamma prior shape and scale</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>  <span class="dt">vector</span> inv_gamma_prior(<span class="dt">vector</span> guess, <span class="dt">vector</span> theta, <span class="dt">array</span>[] <span class="dt">real</span> tails, <span class="dt">array</span>[] <span class="dt">int</span> x_i) {</span>
<span id="cb2-4"><a href="#cb2-4"></a>    <span class="dt">vector</span>[<span class="dv">2</span>] params;</span>
<span id="cb2-5"><a href="#cb2-5"></a>    params[<span class="dv">1</span>] = inv_gamma_cdf(theta[<span class="dv">1</span>] | guess[<span class="dv">1</span>], guess[<span class="dv">2</span>]) - tails[<span class="dv">1</span>];</span>
<span id="cb2-6"><a href="#cb2-6"></a>    params[<span class="dv">2</span>] = inv_gamma_cdf(theta[<span class="dv">2</span>] | guess[<span class="dv">1</span>], guess[<span class="dv">2</span>]) - tails[<span class="dv">2</span>];</span>
<span id="cb2-7"><a href="#cb2-7"></a>    <span class="cf">return</span> params;</span>
<span id="cb2-8"><a href="#cb2-8"></a>  }</span>
<span id="cb2-9"><a href="#cb2-9"></a>}</span>
<span id="cb2-10"><a href="#cb2-10"></a></span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="kw">data</span> {</span>
<span id="cb2-12"><a href="#cb2-12"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; I;  <span class="co">// number of surveys</span></span>
<span id="cb2-13"><a href="#cb2-13"></a>  <span class="dt">array</span>[I] <span class="dt">real</span> survey;  <span class="co">// survey input as number of weeks</span></span>
<span id="cb2-14"><a href="#cb2-14"></a>  <span class="dt">vector</span>[<span class="dv">2</span>] min_max_dist;  <span class="co">// minimum and maximum observed distance between weeks</span></span>
<span id="cb2-15"><a href="#cb2-15"></a>  <span class="dt">array</span>[I] <span class="dt">int</span> y;  <span class="co">// tadpole counts per survey</span></span>
<span id="cb2-16"><a href="#cb2-16"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>, <span class="kw">upper</span>=<span class="dv">1</span>&gt; GP;  <span class="co">// indicator for GP (0 = no, 1 = yes)</span></span>
<span id="cb2-17"><a href="#cb2-17"></a>}</span>
<span id="cb2-18"><a href="#cb2-18"></a></span>
<span id="cb2-19"><a href="#cb2-19"></a><span class="kw">transformed data</span> {</span>
<span id="cb2-20"><a href="#cb2-20"></a>  <span class="dt">vector</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt;[<span class="dv">2</span>] rho_prior = ones_vector(<span class="dv">2</span>);  <span class="co">// length-scale prior shape and scale</span></span>
<span id="cb2-21"><a href="#cb2-21"></a>  <span class="cf">if</span> (GP) {</span>
<span id="cb2-22"><a href="#cb2-22"></a>    rho_prior = <span class="kw">algebra_solver</span>(inv_gamma_prior, [<span class="dv">1</span>, <span class="dv">1</span>]', min_max_dist, {<span class="fl">0.01</span>, <span class="fl">0.99</span>}, {<span class="dv">0</span>});</span>
<span id="cb2-23"><a href="#cb2-23"></a>    <span class="kw">print</span>(<span class="st">"rho_prior: "</span>, rho_prior);</span>
<span id="cb2-24"><a href="#cb2-24"></a>  }</span>
<span id="cb2-25"><a href="#cb2-25"></a>}</span>
<span id="cb2-26"><a href="#cb2-26"></a></span>
<span id="cb2-27"><a href="#cb2-27"></a><span class="kw">parameters</span> {</span>
<span id="cb2-28"><a href="#cb2-28"></a>  <span class="dt">real</span> alpha;  <span class="co">// intercept</span></span>
<span id="cb2-29"><a href="#cb2-29"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; tau, rho;  <span class="co">// random effect SD and GP length-scale</span></span>
<span id="cb2-30"><a href="#cb2-30"></a>  <span class="dt">vector</span>[I] z;  <span class="co">// standard-normal z-scores for non-centered parameterisation</span></span>
<span id="cb2-31"><a href="#cb2-31"></a>}</span>
<span id="cb2-32"><a href="#cb2-32"></a></span>
<span id="cb2-33"><a href="#cb2-33"></a><span class="kw">transformed parameters</span> {</span>
<span id="cb2-34"><a href="#cb2-34"></a>  <span class="dt">vector</span>[I] epsilon;  <span class="co">// random survey effects</span></span>
<span id="cb2-35"><a href="#cb2-35"></a>  <span class="cf">if</span> (GP) {</span>
<span id="cb2-36"><a href="#cb2-36"></a>    epsilon = cholesky_decompose(add_diag(gp_exp_quad_cov(survey, tau, rho), <span class="fl">1e-9</span>)) * z;</span>
<span id="cb2-37"><a href="#cb2-37"></a>  } <span class="cf">else</span> {</span>
<span id="cb2-38"><a href="#cb2-38"></a>    epsilon = tau * z;</span>
<span id="cb2-39"><a href="#cb2-39"></a>  }</span>
<span id="cb2-40"><a href="#cb2-40"></a>}</span>
<span id="cb2-41"><a href="#cb2-41"></a></span>
<span id="cb2-42"><a href="#cb2-42"></a><span class="kw">model</span> {</span>
<span id="cb2-43"><a href="#cb2-43"></a>  <span class="co">// priors</span></span>
<span id="cb2-44"><a href="#cb2-44"></a>  alpha ~ normal(<span class="dv">0</span>, <span class="dv">5</span>);</span>
<span id="cb2-45"><a href="#cb2-45"></a>  tau ~ exponential(<span class="dv">1</span>);</span>
<span id="cb2-46"><a href="#cb2-46"></a>  rho ~ inv_gamma(rho_prior[<span class="dv">1</span>], rho_prior[<span class="dv">2</span>]);</span>
<span id="cb2-47"><a href="#cb2-47"></a>  z ~ std_normal();</span>
<span id="cb2-48"><a href="#cb2-48"></a>    </span>
<span id="cb2-49"><a href="#cb2-49"></a>  <span class="co">// likelihood</span></span>
<span id="cb2-50"><a href="#cb2-50"></a>  y ~ poisson_log(alpha + epsilon);</span>
<span id="cb2-51"><a href="#cb2-51"></a>}</span>
<span id="cb2-52"><a href="#cb2-52"></a></span>
<span id="cb2-53"><a href="#cb2-53"></a><span class="kw">generated quantities</span> {</span>
<span id="cb2-54"><a href="#cb2-54"></a>  <span class="dt">vector</span>[I] yrep, log_lik;</span>
<span id="cb2-55"><a href="#cb2-55"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span>:I) {</span>
<span id="cb2-56"><a href="#cb2-56"></a>    yrep[i] = poisson_log_rng(alpha + epsilon[i]);</span>
<span id="cb2-57"><a href="#cb2-57"></a>    log_lik[i] = poisson_log_lpmf(y[i] | alpha + epsilon[i]);</span>
<span id="cb2-58"><a href="#cb2-58"></a>  }</span>
<span id="cb2-59"><a href="#cb2-59"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>I’ll fit both the normal and GP model with <strong>CmdStanR</strong> <span class="citation" data-cites="gabry2024">(<a href="#ref-gabry2024" role="doc-biblioref">Gabry et al. 2024</a>)</span> in R 4.4.1 <span class="citation" data-cites="rcoreteam2024">(<a href="#ref-rcoreteam2024" role="doc-biblioref">R Core Team 2024</a>)</span>.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># prepare data for Stan</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>stan_data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">I =</span> <span class="fu">nrow</span>(dat), </span>
<span id="cb3-3"><a href="#cb3-3"></a>                  <span class="at">survey =</span> <span class="fu">as.numeric</span>(dat<span class="sc">$</span>date) <span class="sc">/</span> <span class="dv">7</span>, </span>
<span id="cb3-4"><a href="#cb3-4"></a>                  <span class="at">y =</span> dat<span class="sc">$</span>n, </span>
<span id="cb3-5"><a href="#cb3-5"></a>                  <span class="at">GP =</span> <span class="dv">0</span>)</span>
<span id="cb3-6"><a href="#cb3-6"></a></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="co"># get distance matrix and add minimum and maximum observed distances</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>dist_obs <span class="ot">&lt;-</span> <span class="fu">dist</span>(stan_data<span class="sc">$</span>survey) <span class="sc">|&gt;</span> <span class="fu">as.matrix</span>()</span>
<span id="cb3-9"><a href="#cb3-9"></a>stan_data<span class="sc">$</span>min_max_dist <span class="ot">&lt;-</span> <span class="fu">range</span>(dist_obs[dist_obs <span class="sc">&gt;</span> <span class="dv">0</span>])</span>
<span id="cb3-10"><a href="#cb3-10"></a></span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="co"># normal model</span></span>
<span id="cb3-12"><a href="#cb3-12"></a>fit_normal <span class="ot">&lt;-</span> mod<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> stan_data, </span>
<span id="cb3-13"><a href="#cb3-13"></a>                         <span class="at">refresh =</span> <span class="dv">0</span>, <span class="at">chains =</span> <span class="dv">1</span>, </span>
<span id="cb3-14"><a href="#cb3-14"></a>                         <span class="at">iter_warmup =</span> <span class="dv">500</span>, <span class="at">iter_sampling =</span> <span class="dv">4000</span>, </span>
<span id="cb3-15"><a href="#cb3-15"></a>                         <span class="at">show_exceptions =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 1 chain...

Chain 1 finished in 0.3 seconds.</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># GP model</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>stan_data<span class="sc">$</span>GP <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>fit_gp <span class="ot">&lt;-</span> mod<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> stan_data, </span>
<span id="cb5-4"><a href="#cb5-4"></a>                     <span class="at">refresh =</span> <span class="dv">0</span>, <span class="at">chains =</span> <span class="dv">1</span>, </span>
<span id="cb5-5"><a href="#cb5-5"></a>                     <span class="at">iter_warmup =</span> <span class="dv">500</span>, <span class="at">iter_sampling =</span> <span class="dv">4000</span>, </span>
<span id="cb5-6"><a href="#cb5-6"></a>                     <span class="at">show_exceptions =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 1 chain...

Chain 1 rho_prior: [3.58235,38.8276] 
Chain 1 finished in 1.4 seconds.</code></pre>
</div>
</div>
<p>I’ll first plot the inverse gamma prior for the length-scale that was generated by the solver (green), alongside the posterior distribution of <span class="math inline">\(\rho\)</span> (black) and the minimum and maximum observed temporal distances of the surveys (dashed lines), using the <strong>distributional</strong> <span class="citation" data-cites="ohara-wild2024">(<a href="#ref-ohara-wild2024" role="doc-biblioref">O’Hara-Wild et al. 2024</a>)</span> and <strong>ggdist</strong> and <strong>tidybayes</strong> packages <span class="citation" data-cites="kay2024 kay2024a">(<a href="#ref-kay2024" role="doc-biblioref">Kay 2024a</a>, <a href="#ref-kay2024a" role="doc-biblioref">2024b</a>)</span>. The length-scale seems to want to be smaller than the prior allows, which is due to me enforcing an informative prior. Recall that I pretended the survey intervals were chosen in a principled manner to estimate this parameter by specifying a prior implying the length-scale really doesn’t be much shorter than six weeks.</p>
<div class="cell" data-fig.asp="0.618">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="co"># packages</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="fu">library</span>(distributional)</span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="fu">library</span>(ggdist)</span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb7-5"><a href="#cb7-5"></a></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="co"># plot</span></span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="fu">tibble</span>(<span class="at">prior =</span> <span class="fu">dist_inverse_gamma</span>(<span class="fl">3.58</span>, <span class="at">scale =</span> <span class="fl">38.83</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb7-8"><a href="#cb7-8"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">xdist =</span> prior)) <span class="sc">+</span> </span>
<span id="cb7-9"><a href="#cb7-9"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> stan_data<span class="sc">$</span>min_max_dist, </span>
<span id="cb7-10"><a href="#cb7-10"></a>             <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">colour =</span> <span class="st">"#333333"</span>) <span class="sc">+</span></span>
<span id="cb7-11"><a href="#cb7-11"></a>  <span class="fu">stat_slab</span>(<span class="at">fill =</span> green, <span class="at">alpha =</span> <span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">+</span> </span>
<span id="cb7-12"><a href="#cb7-12"></a>  <span class="fu">stat_slab</span>(<span class="fu">aes</span>(<span class="at">xdist =</span> rho), </span>
<span id="cb7-13"><a href="#cb7-13"></a>            <span class="at">data =</span> <span class="fu">spread_rvars</span>(fit_gp, rho), </span>
<span id="cb7-14"><a href="#cb7-14"></a>            <span class="at">fill =</span> <span class="st">"#333333"</span>, <span class="at">alpha =</span> <span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">+</span> </span>
<span id="cb7-15"><a href="#cb7-15"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">60</span>, <span class="dv">20</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">70</span>), <span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span> </span>
<span id="cb7-16"><a href="#cb7-16"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="cn">NULL</span>, <span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span> </span>
<span id="cb7-17"><a href="#cb7-17"></a>  <span class="fu">theme</span>(<span class="at">panel.border =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="cn">NA</span>), </span>
<span id="cb7-18"><a href="#cb7-18"></a>        <span class="at">axis.line.x =</span> <span class="fu">element_line</span>(<span class="at">colour =</span> <span class="st">"#333333"</span>)) <span class="sc">+</span> </span>
<span id="cb7-19"><a href="#cb7-19"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">expression</span>(rho), <span class="at">y =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="gaussian-processes_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Focusing now on the posterior draws for the random survey effects <span class="math inline">\(\epsilon_i\)</span>, it’s clear that the predictions between the normal and GP model are very similar.</p>
<div class="cell" data-fig.asp="0.618">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="co"># add predictions to figure</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb8-3"><a href="#cb8-3"></a>fig <span class="sc">+</span> </span>
<span id="cb8-4"><a href="#cb8-4"></a>  <span class="fu">stat_pointinterval</span>(<span class="fu">aes</span>(<span class="at">ydist =</span> <span class="fu">exp</span>(alpha <span class="sc">+</span> epsilon), </span>
<span id="cb8-5"><a href="#cb8-5"></a>                         <span class="at">shape =</span> <span class="fu">factor</span>(model) <span class="sc">|&gt;</span> <span class="fu">fct_rev</span>()), </span>
<span id="cb8-6"><a href="#cb8-6"></a>                     <span class="at">data =</span> fit_normal <span class="sc">|&gt;</span> </span>
<span id="cb8-7"><a href="#cb8-7"></a>                       <span class="fu">spread_rvars</span>(alpha, epsilon[i]) <span class="sc">|&gt;</span> </span>
<span id="cb8-8"><a href="#cb8-8"></a>                       <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">"Normal"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb8-9"><a href="#cb8-9"></a>                       <span class="fu">bind_cols</span>(dat) <span class="sc">|&gt;</span> </span>
<span id="cb8-10"><a href="#cb8-10"></a>                       <span class="fu">bind_rows</span>(</span>
<span id="cb8-11"><a href="#cb8-11"></a>                         fit_gp <span class="sc">|&gt;</span> </span>
<span id="cb8-12"><a href="#cb8-12"></a>                           <span class="fu">spread_rvars</span>(alpha, epsilon[i]) <span class="sc">|&gt;</span> </span>
<span id="cb8-13"><a href="#cb8-13"></a>                           <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">"GP"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb8-14"><a href="#cb8-14"></a>                           <span class="fu">bind_cols</span>(dat)</span>
<span id="cb8-15"><a href="#cb8-15"></a>                       ), </span>
<span id="cb8-16"><a href="#cb8-16"></a>                     <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="dv">40</span>),</span>
<span id="cb8-17"><a href="#cb8-17"></a>                     <span class="at">point_interval =</span> <span class="st">"median_hdci"</span>, <span class="at">.width =</span> <span class="fl">0.95</span>, </span>
<span id="cb8-18"><a href="#cb8-18"></a>                     <span class="at">size =</span> <span class="dv">1</span>, <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb8-19"><a href="#cb8-19"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#333333"</span>, green)) <span class="sc">+</span> </span>
<span id="cb8-20"><a href="#cb8-20"></a>  <span class="fu">labs</span>(<span class="at">shape =</span> <span class="st">"Model"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="gaussian-processes_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can also see that the standard deviation of the normal model is very similar to the marginal standard deviation of the GP model, albeit with more uncertainty. To be honest, the difference in the estimates of <span class="math inline">\(\tau\)</span> here may be driven more by our prior on <span class="math inline">\(\rho\)</span> that may be a bit more informative than it should be.</p>
<div class="cell" data-fig.asp="0.618">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>fit_normal <span class="sc">|&gt;</span> </span>
<span id="cb9-2"><a href="#cb9-2"></a>  <span class="fu">spread_rvars</span>(tau) <span class="sc">|&gt;</span> </span>
<span id="cb9-3"><a href="#cb9-3"></a>  <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">"Normal"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-4"><a href="#cb9-4"></a>  <span class="fu">bind_rows</span>(fit_gp <span class="sc">|&gt;</span> </span>
<span id="cb9-5"><a href="#cb9-5"></a>              <span class="fu">spread_rvars</span>(tau) <span class="sc">|&gt;</span> </span>
<span id="cb9-6"><a href="#cb9-6"></a>              <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">"GP"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb9-7"><a href="#cb9-7"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="fu">factor</span>(model) <span class="sc">|&gt;</span> <span class="fu">fct_rev</span>(), <span class="at">ydist =</span> tau)) <span class="sc">+</span></span>
<span id="cb9-8"><a href="#cb9-8"></a>  <span class="fu">stat_pointinterval</span>(<span class="at">point_interval =</span> <span class="st">"median_hdci"</span>, <span class="at">.width =</span> <span class="fl">0.95</span>, </span>
<span id="cb9-9"><a href="#cb9-9"></a>                     <span class="at">size =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb9-10"><a href="#cb9-10"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#333333"</span>, <span class="st">"red4"</span>)) <span class="sc">+</span> </span>
<span id="cb9-11"><a href="#cb9-11"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Model"</span>, <span class="at">y =</span> <span class="fu">expression</span>(<span class="fu">paste</span>(<span class="st">"Posterior distribution of "</span>, tau)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="gaussian-processes_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="plotting-predictions" class="level1">
<h1>Plotting predictions</h1>
<p>It can be hard to interpret the parameters of the GP directly so I will make some predictions over unobserved surveys in weekly intervals. Making GP predictions involves linear algebra that I don’t pretend to fully understand. Below is some code I modified from Nicholas Clark’s excellent <a href="https://rpubs.com/NickClark47/stan_geostatistical">blog post</a> on spatial GPs.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="co"># predicted dates and distance matrix</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>pred_dates <span class="ot">&lt;-</span> <span class="fu">seq.Date</span>(<span class="fu">min</span>(dat<span class="sc">$</span>date) <span class="sc">-</span> <span class="fu">weeks</span>(<span class="dv">2</span>), <span class="fu">max</span>(dat<span class="sc">$</span>date) <span class="sc">+</span> <span class="fu">weeks</span>(<span class="dv">2</span>), <span class="dv">7</span>)</span>
<span id="cb10-3"><a href="#cb10-3"></a>pred <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(pred_dates) <span class="sc">/</span> <span class="dv">7</span></span>
<span id="cb10-4"><a href="#cb10-4"></a>dist_pred <span class="ot">&lt;-</span> <span class="fu">dist</span>(pred) <span class="sc">|&gt;</span> <span class="fu">as.matrix</span>()</span>
<span id="cb10-5"><a href="#cb10-5"></a></span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="co"># distance matrix between observed and predicted dates</span></span>
<span id="cb10-7"><a href="#cb10-7"></a>dist_obs_to_pred <span class="ot">&lt;-</span> proxy<span class="sc">::</span><span class="fu">dist</span>(stan_data<span class="sc">$</span>survey, pred)</span>
<span id="cb10-8"><a href="#cb10-8"></a></span>
<span id="cb10-9"><a href="#cb10-9"></a><span class="co"># squared exponential kernel function</span></span>
<span id="cb10-10"><a href="#cb10-10"></a>gp_exp_quad_cov <span class="ot">&lt;-</span> <span class="cf">function</span>(dist, tau, rho, <span class="at">nugget =</span> <span class="fl">1e-9</span>) {</span>
<span id="cb10-11"><a href="#cb10-11"></a>  <span class="fu">return</span>(tau<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="fl">0.5</span> <span class="sc">*</span> (dist <span class="sc">/</span> rho)<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">+</span> <span class="fu">diag</span>(nugget, <span class="fu">dim</span>(dist)[<span class="dv">1</span>])</span>
<span id="cb10-12"><a href="#cb10-12"></a>}</span>
<span id="cb10-13"><a href="#cb10-13"></a></span>
<span id="cb10-14"><a href="#cb10-14"></a><span class="co"># function from Nicholas Clark</span></span>
<span id="cb10-15"><a href="#cb10-15"></a>predict_gp <span class="ot">&lt;-</span> <span class="cf">function</span>(tau, rho, epsilon, dist_obs, dist_pred, dist_obs_to_pred, <span class="at">nugget =</span> <span class="fl">1e-9</span>) {</span>
<span id="cb10-16"><a href="#cb10-16"></a>  </span>
<span id="cb10-17"><a href="#cb10-17"></a>  <span class="co"># estimated covariance kernel for the fitted points</span></span>
<span id="cb10-18"><a href="#cb10-18"></a>  K_obs <span class="ot">&lt;-</span> <span class="fu">gp_exp_quad_cov</span>(dist_obs, tau, rho)</span>
<span id="cb10-19"><a href="#cb10-19"></a>  </span>
<span id="cb10-20"><a href="#cb10-20"></a>  <span class="co"># estimated covariance kernel for prediction points</span></span>
<span id="cb10-21"><a href="#cb10-21"></a>  K_pred <span class="ot">&lt;-</span> <span class="fu">gp_exp_quad_cov</span>(dist_pred, tau, rho)</span>
<span id="cb10-22"><a href="#cb10-22"></a>  </span>
<span id="cb10-23"><a href="#cb10-23"></a>  <span class="co"># cross-covariance between fitted and prediction points</span></span>
<span id="cb10-24"><a href="#cb10-24"></a>  K_new <span class="ot">&lt;-</span> <span class="fu">gp_exp_quad_cov</span>(dist_obs_to_pred, tau, rho)</span>
<span id="cb10-25"><a href="#cb10-25"></a>  </span>
<span id="cb10-26"><a href="#cb10-26"></a>  <span class="co"># number of prediction points</span></span>
<span id="cb10-27"><a href="#cb10-27"></a>  n_pred <span class="ot">&lt;-</span> <span class="fu">dim</span>(dist_pred)[<span class="dv">1</span>]</span>
<span id="cb10-28"><a href="#cb10-28"></a>  </span>
<span id="cb10-29"><a href="#cb10-29"></a>  <span class="co"># posterior draw for prediction points</span></span>
<span id="cb10-30"><a href="#cb10-30"></a>  <span class="fu">return</span>(<span class="fu">t</span>(K_new) <span class="sc">%*%</span> <span class="fu">solve</span>(K_obs, epsilon) <span class="sc">+</span> </span>
<span id="cb10-31"><a href="#cb10-31"></a>           <span class="fu">t</span>(<span class="fu">chol</span>(K_pred <span class="sc">-</span> <span class="fu">t</span>(K_new) <span class="sc">%*%</span> <span class="fu">solve</span>(K_obs, K_new) <span class="sc">+</span> <span class="fu">diag</span>(nugget, n_pred))) <span class="sc">%*%</span> <span class="fu">rnorm</span>(n_pred))</span>
<span id="cb10-32"><a href="#cb10-32"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Next I extract the posterior draws of the model parameters to use the <code>predict_gp()</code> function for each draw to capture uncertainty. Then I plot the predictions over our existing figure. The GP was able to capture higher tadpole counts in the warmer months when reproduction is occurring, and that the winter and spring months prior to the first pulse of reproduction (July–October 2020) had low tadpole numbers. It’s possible that a different covariance kernel would work better, such as a <a href="https://mc-stan.org/docs/functions-reference/matrix_operations.html#periodic-kernel">periodic covariance kernel</a>, but I won’t go into that here.</p>
<div class="cell" data-fig.asp="0.618">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="co"># posterior draws</span></span>
<span id="cb11-2"><a href="#cb11-2"></a>alpha <span class="ot">&lt;-</span> <span class="fu">spread_draws</span>(fit_gp, alpha)<span class="sc">$</span>alpha</span>
<span id="cb11-3"><a href="#cb11-3"></a>tau <span class="ot">&lt;-</span> <span class="fu">spread_draws</span>(fit_gp, tau)<span class="sc">$</span>tau</span>
<span id="cb11-4"><a href="#cb11-4"></a>rho <span class="ot">&lt;-</span> <span class="fu">spread_draws</span>(fit_gp, rho)<span class="sc">$</span>rho</span>
<span id="cb11-5"><a href="#cb11-5"></a>epsilon <span class="ot">&lt;-</span> <span class="fu">spread_draws</span>(fit_gp, epsilon[i])</span>
<span id="cb11-6"><a href="#cb11-6"></a>n_draws <span class="ot">&lt;-</span> <span class="fu">length</span>(alpha)</span>
<span id="cb11-7"><a href="#cb11-7"></a></span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="co"># make predictions</span></span>
<span id="cb11-9"><a href="#cb11-9"></a>pred <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="at">.x =</span> <span class="dv">1</span><span class="sc">:</span>n_draws, </span>
<span id="cb11-10"><a href="#cb11-10"></a>            <span class="at">.f =</span> <span class="sc">~</span>(<span class="fu">tibble</span>(</span>
<span id="cb11-11"><a href="#cb11-11"></a>              <span class="at">.draw =</span> .x, </span>
<span id="cb11-12"><a href="#cb11-12"></a>              <span class="at">date =</span> pred_dates, </span>
<span id="cb11-13"><a href="#cb11-13"></a>              <span class="at">alpha =</span> alpha[.x], </span>
<span id="cb11-14"><a href="#cb11-14"></a>              <span class="at">gp_f =</span> <span class="fu">predict_gp</span>(</span>
<span id="cb11-15"><a href="#cb11-15"></a>                <span class="at">tau =</span> tau[.x], </span>
<span id="cb11-16"><a href="#cb11-16"></a>                <span class="at">rho =</span> rho[.x], </span>
<span id="cb11-17"><a href="#cb11-17"></a>                <span class="at">epsilon =</span> <span class="fu">filter</span>(epsilon, .draw <span class="sc">==</span> .x) <span class="sc">|&gt;</span> <span class="fu">pull</span>(epsilon), </span>
<span id="cb11-18"><a href="#cb11-18"></a>                <span class="at">dist_obs =</span> dist_obs, </span>
<span id="cb11-19"><a href="#cb11-19"></a>                <span class="at">dist_pred =</span> dist_pred, </span>
<span id="cb11-20"><a href="#cb11-20"></a>                <span class="at">dist_obs_to_pred =</span> dist_obs_to_pred</span>
<span id="cb11-21"><a href="#cb11-21"></a>              )[, <span class="dv">1</span>]</span>
<span id="cb11-22"><a href="#cb11-22"></a>            ))) <span class="sc">|&gt;</span> </span>
<span id="cb11-23"><a href="#cb11-23"></a>  <span class="fu">list_rbind</span>()</span>
<span id="cb11-24"><a href="#cb11-24"></a></span>
<span id="cb11-25"><a href="#cb11-25"></a><span class="co"># add to figure</span></span>
<span id="cb11-26"><a href="#cb11-26"></a>fig <span class="sc">+</span> </span>
<span id="cb11-27"><a href="#cb11-27"></a>  <span class="fu">stat_lineribbon</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">exp</span>(alpha <span class="sc">+</span> gp_f)), </span>
<span id="cb11-28"><a href="#cb11-28"></a>                  <span class="at">data =</span> pred, </span>
<span id="cb11-29"><a href="#cb11-29"></a>                  <span class="at">point_interval =</span> <span class="st">"median_qi"</span>, </span>
<span id="cb11-30"><a href="#cb11-30"></a>                  <span class="at">.width =</span> <span class="fl">0.9</span>, </span>
<span id="cb11-31"><a href="#cb11-31"></a>                  <span class="at">colour =</span> green, </span>
<span id="cb11-32"><a href="#cb11-32"></a>                  <span class="at">fill =</span> green, </span>
<span id="cb11-33"><a href="#cb11-33"></a>                  <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">+</span> </span>
<span id="cb11-34"><a href="#cb11-34"></a>  <span class="fu">scale_x_date</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="gaussian-processes_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Using GPs to model random effects makes a lot of sense if there is some interest in modeling correlation between temporally or spatially organised data. Given that switching out the normally distributed random effects for a GP is trivial in modern probabilistic programming languages such as Stan, it makes sense to default to using them, especially as it includes involves just one extra parameter, the length-scale <span class="math inline">\(\rho\)</span>.</p>
</section>
<section id="references" class="level2">




</section>
</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-line-spacing="2" role="list">
<div id="ref-carpenter2017" class="csl-entry" role="listitem">
Carpenter, B., A. Gelman, M. D. Hoffman, D. Lee, B. Goodrich, M. Betancourt, M. Brubaker, J. Guo, P. Li, and A. Riddell. 2017. <a href="https://doi.org/10.18637/jss.v076.i01">Stan: A Probabilistic Programming Language</a>. Journal of Statistical Software 76:1–32.
</div>
<div id="ref-gabry2024" class="csl-entry" role="listitem">
Gabry, J., R. Češnovar, A. Johnson, and S. Bronder. 2024. cmdstanr: R Interface to <span>“CmdStan.”</span> manual.
</div>
<div id="ref-hollanders2024" class="csl-entry" role="listitem">
Hollanders, M., L. F. Grogan, H. I. McCallum, and D. A. Newell. 2024. <a href="https://doi.org/10.1071/WR23126">High chytrid prevalence and infection intensities in tadpoles of <em>Mixophyes fleayi</em></a>. Wildlife Research 51.
</div>
<div id="ref-kay2024" class="csl-entry" role="listitem">
Kay, M. 2024a. <a href="https://doi.org/10.5281/zenodo.1308151"><span class="nocase">tidybayes</span>: Tidy data and geoms for Bayesian models</a>. manual.
</div>
<div id="ref-kay2024a" class="csl-entry" role="listitem">
Kay, M. 2024b. <a href="https://doi.org/10.5281/zenodo.3879620"><span class="nocase">ggdist</span>: Visualizations of distributions and uncertainty</a>. manual.
</div>
<div id="ref-ohara-wild2024" class="csl-entry" role="listitem">
O’Hara-Wild, M., M. Kay, and A. Hayes. 2024. <a href="https://CRAN.R-project.org/package=distributional">distributional: Vectorised probability distributions</a>. manual.
</div>
<div id="ref-rcoreteam2024" class="csl-entry" role="listitem">
R Core Team. 2024. <a href="https://www.R-project.org/">R: A language and environment for statistical computing</a>. R Foundation for Statistical Computing, Vienna, Austria.
</div>
<div id="ref-simpson2021" class="csl-entry" role="listitem">
Simpson, D. 2021, November 3. Yes but what is a Gaussian process? Or, Once, twice, three times a definition; or A descent into madness. <a href="https://dansblog.netlify.app/yes-but-what-is-a-gaussian-process-or-once-twice-three-times-a-definition-or-a-descent-into-madness">https://dansblog.netlify.app/yes-but-what-is-a-gaussian-process-or-once-twice-three-times-a-definition-or-a-descent-into-madness</a>.
</div>
<div id="ref-wickham2016" class="csl-entry" role="listitem">
Wickham, H. 2016. <a href="https://ggplot2.tidyverse.org"><span class="nocase">ggplot2</span>: Elegant graphics for data analysis</a>. Springer-Verlag New York.
</div>
<div id="ref-wickham2019" class="csl-entry" role="listitem">
Wickham, H., M. Averick, J. Bryan, W. Chang, L. D. McGowan, R. François, G. Grolemund, A. Hayes, L. Henry, J. Hester, M. Kuhn, T. L. Pedersen, E. Miller, S. M. Bache, K. Müller, J. Ooms, D. Robinson, D. P. Seidel, V. Spinu, K. Takahashi, D. Vaughan, C. Wilke, K. Woo, and H. Yutani. 2019. <a href="https://doi.org/10.21105/joss.01686">Welcome to the <span class="nocase">tidyverse</span></a>. Journal of Open Source Software 4:1686.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Dan Simpson’s blog is a great place to learn more about GPs.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>When our input is multidimensional, such as coordinates for spatial data, we are still working with the Euclidean distance between vectors.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>I also did other things with those tadpoles, but I won’t go into that here.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>This also happens to the penalised complexity (PC) prior for this parameter.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>The case study is a great place to learn more about GPs more generally.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp("https:\/\/quantecol\.com\.au");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // default icon
          link.classList.add("external");
      }
    }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">Quantecol | 53 Bentinck Street, Ballina NSW, Australia | ABN: 90 710 874 314</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>